From 8fb19ec8f816dcceed2e587d913245ebf87973d5 Mon Sep 17 00:00:00 2001
From: Michal Hrusecky <michal.hrusecky@nic.cz>
Date: Thu, 28 Mar 2019 17:46:18 +0100
Subject: [PATCH] mozilla-iot-gateway: Better integration

---
 lang/node-mozilla-iot-gateway/Makefile | 21 +++++++++++++--------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/lang/node-mozilla-iot-gateway/Makefile b/lang/node-mozilla-iot-gateway/Makefile
index 3289a05..d735dda 100644
--- a/lang/node-mozilla-iot-gateway/Makefile
+++ b/lang/node-mozilla-iot-gateway/Makefile
@@ -30,7 +30,7 @@ define Package/node-mozilla-iot-gateway
   CATEGORY:=Languages
   TITLE:=WebThings Gateway by Mozilla
   URL:=https://iot.mozilla.org/gateway/
-  DEPENDS:= +libpthread +node +node-npm +libopenzwave +openzwave-config +python +python3-light +python3-pip +openssl-util
+  DEPENDS:= +libpthread +node +node-npm +libopenzwave +openzwave-config +python +python3-light +python3-pip +openssl-util +mozilla-iot-gateway-webapp
   DEPENDS+= +MOIT_enable-plugin-support:git-http
   MENU:=1
 endef
@@ -63,18 +63,23 @@ define Build/Compile
 endef
 
 define Package/node-mozilla-iot-gateway/install
-	$(INSTALL_DIR) $(1)/opt/mozilla-iot/gateway/
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/node_modules/webthings-gateway/* $(1)/opt/mozilla-iot/gateway
-	$(STAGING_DIR_HOSTPKG)/bin/npm --prefix=$(1)/opt/mozilla-iot/gateway install $(1)/opt/mozilla-iot/gateway
+	$(INSTALL_DIR) $(1)/srv/mozilla-iot/gateway/
+	$(INSTALL_DIR) $(1)/srv/mozilla-iot-home
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/node_modules/webthings-gateway/* $(1)/srv/mozilla-iot/gateway
+	$(STAGING_DIR_HOSTPKG)/bin/npm --prefix=$(1)/srv/mozilla-iot/gateway install $(1)/srv/mozilla-iot/gateway
 
 	# Clean up of old build files that confuse OpenWrt's dependency checker
-	$(RM) -r $(1)/opt/mozilla-iot/gateway/node_modules/sqlite3/lib/binding/node-v57-linux-x64
-	$(RM) -r $(1)/opt/mozilla-iot/gateway/node_modules/ursa/build/Release/ursaNative.node
-	$(RM) -r $(1)/opt/mozilla-iot/gateway/node_modules/ursa/build/Release/obj.target/ursaNative.node
+	$(RM) -r $(1)/srv/mozilla-iot/gateway/node_modules/sqlite3/lib/binding/node-v57-linux-x64
+	$(RM) -r $(1)/srv/mozilla-iot/gateway/node_modules/ursa/build/Release/ursaNative.node
+	$(RM) -r $(1)/srv/mozilla-iot/gateway/node_modules/ursa/build/Release/obj.target/ursaNative.node
 
 	$(INSTALL_DIR) $(1)/opt/mozilla-iot/gateway/node_modules/sqlite3/lib/binding/node-v57-linux-$(CPU)/
 	$(CP) $(PKG_INSTALL_DIR)/usr/lib/node_modules/webthings-gateway/node_modules/sqlite3/lib/binding/node-v57-linux-$(CPU)/node_sqlite3.node \
-		$(1)/opt/mozilla-iot/gateway/node_modules/sqlite3/lib/binding/node-v57-linux-$(CPU)/
+		$(1)/srv/mozilla-iot/gateway/node_modules/sqlite3/lib/binding/node-v57-linux-$(CPU)/
+
+	# Custom configuration
+	sed -i "s|home = .*|home = '/srv/mozilla-iot-home';|" $(1)/srv/mozilla-iot/gateway/config/default.js
+	sed -i "s|behindForwarding:.*|behindForwarding: false,|" $(1)/srv/mozilla-iot/gateway/config/default.js
 
 	$(INSTALL_DIR) $(1)/etc/init.d
 	$(INSTALL_BIN) ./files/mozilla-iot-gateway.init $(1)/etc/init.d/mozilla-iot-gateway
-- 
2.21.0

