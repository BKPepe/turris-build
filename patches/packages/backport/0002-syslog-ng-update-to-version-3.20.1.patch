From 6d8195b053149934be8b9b48a50c51e528a6459a Mon Sep 17 00:00:00 2001
From: Josef Schlehofer <pepe.schlehofer@gmail.com>
Date: Wed, 13 Mar 2019 18:03:49 +0100
Subject: [PATCH] syslog-ng: update to version 3.20.1

Signed-off-by: Josef Schlehofer <pepe.schlehofer@gmail.com>
---
 admin/syslog-ng/Makefile                      | 96 ++++++++++++-------
 admin/syslog-ng/files/logread                 | 76 +++++++++++++++
 admin/syslog-ng/files/syslog-ng.conf          | 47 ++++++---
 admin/syslog-ng/files/syslog-ng.init          | 33 ++-----
 .../patches/100-use-1.0.2k-threadids.patch    | 35 -------
 5 files changed, 183 insertions(+), 104 deletions(-)
 create mode 100644 admin/syslog-ng/files/logread
 delete mode 100644 admin/syslog-ng/patches/100-use-1.0.2k-threadids.patch

diff --git a/admin/syslog-ng/Makefile b/admin/syslog-ng/Makefile
index e294ff577..76f3ce759 100644
--- a/admin/syslog-ng/Makefile
+++ b/admin/syslog-ng/Makefile
@@ -1,26 +1,33 @@
-include  $(TOPDIR)/rules.mk
+include $(TOPDIR)/rules.mk
 
 PKG_NAME:=syslog-ng
-PKG_VERSION:=3.9.1
-PKG_RELEASE:=3
+PKG_VERSION:=3.21.1
+PKG_RELEASE:=1
 
-PKG_MAINTAINER:=W. Michael Petullo <mike@flyn.org>
+PKG_MAINTAINER:=Josef Schlehofer <josef.schlehofer@nic.cz>
+PKG_LICENSE:=LGPL-2.1+
+PKG_LICENSE_FILES:=COPYING
+PKG_CPE_ID:=cpe:/a:balabit:syslog-ng
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
 PKG_SOURCE_URL:=https://github.com/balabit/syslog-ng/releases/download/$(PKG_NAME)-$(PKG_VERSION)/
-PKG_HASH:=5678856a550ae790618fabde9d1447f932ce7a9080d55dca8fc5df1202c70a17
+PKG_HASH:=8d163da5ad79cf3a5f043b2ed0fe18a4888d0d740542703bf2508f0b9996cd25
 
+PKG_BUILD_PARALLEL:=1
 PKG_INSTALL:=1
 
+PKG_CONFIG_DEPENDS:= \
+	CONFIG_IPV6 \
+
 include $(INCLUDE_DIR)/package.mk
 include $(INCLUDE_DIR)/nls.mk
 
 define Package/syslog-ng
   SECTION:=admin
   CATEGORY:=Administration
-  DEPENDS:=+libpcre +glib2 +libeventlog +libopenssl +libuuid +libcurl
+  DEPENDS:=+libpcre +glib2 +libopenssl +libpthread +librt +zlib +libdbi +libjson-c +libcurl +libuuid
   TITLE:=A powerful syslog daemon
-  URL:=http://www.balabit.com/network-security/syslog-ng/opensource-logging-system/
+  URL:=https://www.syslog-ng.com/products/open-source-log-management/
 endef
 
 define Package/syslog-ng/description
@@ -32,6 +39,7 @@ endef
 define Package/syslog-ng/conffiles
 /etc/syslog-ng.conf
 /etc/syslog-ng.d/
+/etc/scl.conf
 endef
 
 define Build/Configure
@@ -39,39 +47,61 @@ define Build/Configure
 	$(Build/Configure/Default)
 endef
 
-CONFIGURE_ARGS += \
-  $(call autoconf_bool,CONFIG_IPV6,ipv6) \
-         --disable-dependency-tracking \
-         --disable-amqp \
-         --disable-tcp-wrapper \
-         --disable-glibtest \
-         --disable-mongodb \
-         --disable-java \
-         --disable-json \
-         --disable-python \
-         --disable-spoof-source \
-         --disable-sql \
-         --disable-linux-caps \
-	 --disable-smtp \
-	 --disable-redis \
-         --enable-prce \
-
-TARGET_CPPFLAGS += \
-  -I$(STAGING_DIR)/usr/include/eventlog
+CONFIGURE_ARGS +=  \
+	$(call autoconf_bool,CONFIG_IPV6,ipv6) \
+	--disable-tcp-wrapper \
+	--disable-spoof-source \
+	--disable-sql \
+	--disable-linux-caps \
+	--with-jsonc=system \
+	--enable-json=yes \
+	--enable-http=yes \
+	--disable-smtp \
+	--disable-redis \
+	--disable-dependency-tracking \
+	--disable-python \
+	--disable-java \
+	--disable-java-modules \
+	--with-librabbitmq-client=no \
+	--with-mongoc=no
 
 CONFIGURE_VARS += \
-  LIBDBI_CFLAGS="-I$(STAGING_DIR)/usr/include"
+	LIBDBI_CFLAGS="-I$(STAGING_DIR)/usr/include"
 
 define Package/syslog-ng/install
-	$(INSTALL_DIR) $(1)/usr/lib
-	$(MAKE) -C $(PKG_BUILD_DIR) \
-		install-sbinPROGRAMS install-libLTLIBRARIES \
-		install-moduleLTLIBRARIES DESTDIR="$(1)"
+	cd $(PKG_BUILD_DIR); make DESTDIR=$(1) install
+
+	$(call libtool_remove_files,$(1)) # This removes .la files in folder (including subfolders) /usr/lib
+	rm -rf $(1)/usr/lib/pkgconfig \
+	$(1)/usr/lib/*.a \
+	$(1)/usr/include \
+	$(1)/var
+
 	$(INSTALL_DIR) $(1)/etc/init.d
 	$(INSTALL_BIN) ./files/syslog-ng.init $(1)/etc/init.d/syslog-ng
+	$(INSTALL_DIR) $(1)/etc/syslog-ng.d
 	$(INSTALL_DATA) ./files/syslog-ng.conf $(1)/etc
-	$(INSTALL_DIR) $(1)/etc/syslog-ng.d/
-	$(call libtool_remove_files,$(1))
+	touch $(1)/etc/syslog-ng.d/.keep
+
+	$(INSTALL_BIN) ./files/logread $(1)/usr/sbin
+endef
+
+define Package/syslog-ng/postinst
+#!/bin/sh
+
+[ -n "$$IPKG_INSTROOT" ] || {
+/etc/init.d/syslog-ng enable
+/etc/init.d/syslog-ng restart
+}
+endef
+
+define Package/syslog-ng/prerm
+#!/bin/sh
+
+[ -n "$$IPKG_INSTROOT" ] || {
+/etc/init.d/syslog-ng disable
+/etc/init.d/syslog-ng stop
+}
 endef
 
 $(eval $(call BuildPackage,syslog-ng))
diff --git a/admin/syslog-ng/files/logread b/admin/syslog-ng/files/logread
new file mode 100644
index 000000000..9dfe357d0
--- /dev/null
+++ b/admin/syslog-ng/files/logread
@@ -0,0 +1,76 @@
+#!/bin/sh
+# Shell script compatibility wrapper for /sbin/logread
+#
+# Copyright (C) 2019 Dirk Brenken <dev@brenken.org>
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+# General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+#
+
+logfile="/var/log/messages"
+
+if [ ! -f "${logfile}" ]
+then
+	printf "%s\n" "Error: logfile not found!"
+	exit 2
+fi
+
+usage()
+{
+	printf "%s\n" "Usage: logread [options]"
+	printf "%s\n" "Options:"
+	printf "%5s %-10s%s\n" "-l" "<count>" "Got only the last 'count' messages"
+	printf "%5s %-10s%s\n" "-e" "<pattern>" "Filter messages with a regexp"
+	printf "%5s %-10s%s\n" "-f" "" "Follow log messages"
+	printf "%5s %-10s%s\n" "-h" "" "Print this help message"
+}
+
+if [ -z "${1}" ]
+then
+	cat "${logfile}"
+	exit 0
+else
+	while [ "${1}" ]
+	do
+		case "${1}" in
+			-l)
+				shift
+				count="${1//[^0-9]/}"
+				tail -n "${count:-50}" "${logfile}"
+				exit 0
+				;;
+			-e)
+				shift
+				pattern="${1}"
+				grep -E "${pattern}" "${logfile}"
+				exit 0
+				;;
+			-f)
+				tail -f "${logfile}"
+				exit 0
+				;;
+			-fe)
+				shift
+				pattern="${1}"
+				tail -f "${logfile}" | grep -E "${pattern}"
+				exit 0
+				;;
+			-h|*)
+				usage
+				exit 1
+				;;
+		esac
+		shift
+	done
+fi
diff --git a/admin/syslog-ng/files/syslog-ng.conf b/admin/syslog-ng/files/syslog-ng.conf
index cae24a848..c6f5c42bf 100644
--- a/admin/syslog-ng/files/syslog-ng.conf
+++ b/admin/syslog-ng/files/syslog-ng.conf
@@ -1,17 +1,26 @@
-@version:3.9
+#############################################################################
+# OpenWrt syslog-ng.conf specific file
+# which collects all local logs into a single file called /var/log/messages.
+# More details about these settings can be found here:
+# https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/3.16/release-notes/global-options
+
+@version: 3.21
+@include "scl.conf"
+@include "/etc/syslog-ng.d/" # Put any customization files in this directory
 
 options {
-	chain_hostnames(no);
+	chain_hostnames(no); # Enable or disable the chained hostname format.
 	create_dirs(yes);
-	flush_lines(0);
-	keep_hostname(yes);
-	log_fifo_size(256);
-	log_msg_size(1024);
-	stats_freq(0);
-	flush_lines(0);
-	use_fqdn(no);
+	keep_hostname(yes); # Enable or disable hostname rewriting.
+	log_fifo_size(256); # The number of messages that the output queue can store.
+	log_msg_size(1024); # Maximum length of a message in bytes.
+	stats_freq(0); # The period between two STATS messages (sent by syslog-ng, containing statistics about dropped logs) in seconds.
+	flush_lines(0); # How many lines are flushed to a destination at a time.
+	use_fqdn(no); # Add Fully Qualified Domain Name instead of short hostname.
 };
 
+# syslog-ng gets messages from syslog-ng (internal) and from /dev/log
+
 source src {
 	internal();
 	unix-dgram("/dev/log");
@@ -21,6 +30,19 @@ source net {
 	udp(ip(0.0.0.0) port(514));
 };
 
+source s_network {
+	default-network-drivers(
+		# NOTE: TLS support
+		#
+		# the default-network-drivers() source driver opens the TLS
+		# enabled ports as well, however without an actual key/cert
+		# pair they will not operate and syslog-ng would display a
+		# warning at startup.
+		#
+		#tls(key-file("/path/to/ssl-private-key") cert-file("/path/to/ssl-cert"))
+	);
+};
+
 source kernel {
         file("/proc/kmsg" program_override("kernel"));
 };
@@ -34,8 +56,7 @@ log {
 	source(net);
         source(kernel);
 	destination(messages);
-};
-
-# put any customization files in this directory
-@include "/etc/syslog-ng.d/"
 
+	# uncomment this line to open port 514 to receive messages
+	#source(s_network);
+};
diff --git a/admin/syslog-ng/files/syslog-ng.init b/admin/syslog-ng/files/syslog-ng.init
index bb03de672..7b9488b28 100644
--- a/admin/syslog-ng/files/syslog-ng.init
+++ b/admin/syslog-ng/files/syslog-ng.init
@@ -1,31 +1,18 @@
 #!/bin/sh /etc/rc.common
 # Copyright (C) 2006-2016 OpenWrt.org
 
-START=20
-PROG=/usr/sbin/syslog-ng
-PROG2=/usr/sbin/syslog-ng-ctl
+START=50
 
-SERVICE_USE_PID=1
-SERVICE_PID_FILE=/var/run/syslog-ng.pid
+USE_PROCD=1
 
-config_file=/etc/syslog-ng.conf
-
-start() {
-	[ -f $config_file ] || return 1
-
-	if ! $PROG -s 2>/dev/null ; then
-		echo "Couldn't parse $(basename $config_file)" >&2
-		exit 1
-	fi
-
-	service_start $PROG --process-mode background \
-		-p $SERVICE_PID_FILE
-}
-
-stop() {
-	service_stop $PROG
+start_service() {
+	[ -f /etc/syslog-ng.conf ] || return 1
+	procd_open_instance
+	procd_set_param command /usr/sbin/syslog-ng
+	procd_close_instance
 }
 
-reload() {
-	$PROG2 reload
+reload_service() {
+        stop
+        start
 }
diff --git a/admin/syslog-ng/patches/100-use-1.0.2k-threadids.patch b/admin/syslog-ng/patches/100-use-1.0.2k-threadids.patch
deleted file mode 100644
index 17c005aa8..000000000
--- a/admin/syslog-ng/patches/100-use-1.0.2k-threadids.patch
+++ /dev/null
@@ -1,35 +0,0 @@
---- a/lib/crypto.c	2016-12-21 07:57:44.000000000 -0700
-+++ b/lib/crypto.c	2017-03-24 13:19:34.188259018 -0600
-@@ -51,11 +51,20 @@
-     }
- }
- 
-+#if OPENSSL_VERSION_NUMBER < 0x10000000
- static unsigned long
- ssl_thread_id(void)
- {
-   return (unsigned long) get_thread_id();
- }
-+
-+#else
-+static void
-+ssl_thread_id2(CRYPTO_THREADID *id)
-+{
-+  CRYPTO_THREADID_set_numeric(id, get_thread_id());
-+}
-+#endif
- 
- static void
- crypto_init_threading(void)
-@@ -68,7 +76,11 @@
-     {
-       g_static_mutex_init(&ssl_locks[i]);
-     }
-+#if OPENSSL_VERSION_NUMBER < 0x10000000
-   CRYPTO_set_id_callback(ssl_thread_id);
-+#else
-+  CRYPTO_THREADID_set_callback(ssl_thread_id2);
-+#endif
-   CRYPTO_set_locking_callback(ssl_locking_callback);
- }
- 
-- 
2.19.1

