From 2f036567cdca807833ebe78fab64b6efcab7bb1e Mon Sep 17 00:00:00 2001
From: Jan Pavlinec <jan.pavlinec@nic.cz>
Date: Sat, 9 Feb 2019 14:40:59 +0100
Subject: [PATCH] libv4l: update to upsream version and fix libintl dependecy
 error

---
 libs/libv4l/Makefile                               | 30 ++++----
 libs/libv4l/patches/010-remove-libudev-check.patch | 22 ++++++
 libs/libv4l/patches/020-add-missing-includes.patch | 80 ++++++++++++++++------
 libs/libv4l/patches/030-dont-call-getsubopt.patch  | 28 --------
 4 files changed, 94 insertions(+), 66 deletions(-)
 create mode 100644 libs/libv4l/patches/010-remove-libudev-check.patch
 delete mode 100644 libs/libv4l/patches/030-dont-call-getsubopt.patch

diff --git a/libs/libv4l/Makefile b/libs/libv4l/Makefile
index d9a4d8c..0b8af5d 100644
--- a/libs/libv4l/Makefile
+++ b/libs/libv4l/Makefile
@@ -1,7 +1,4 @@
 #
-# Copyright (C) 2009-2015 OpenWrt.org
-# Copyright (C) 2009 David Cooper <dave@kupesoft.com>
-#
 # This is free software, licensed under the GNU General Public License v2.
 # See /LICENSE for more information.
 #
@@ -9,15 +6,14 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=v4l-utils
-PKG_VERSION:=1.10.0
+PKG_VERSION:=1.16.3
 PKG_RELEASE:=1
 
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.bz2
-PKG_SOURCE_URL:=http://www.linuxtv.org/downloads/v4l-utils
-PKG_HASH:=78ead27ee58a701d7c6342303cf4520bdd4a2b88a7813bc99a0b389307e4336b
+PKG_SOURCE_URL:=https://www.linuxtv.org/downloads/v4l-utils
+PKG_HASH:=7c5c0d49c130cf65d384f28e9f3a53c5f7d17bf18740c48c40810e0fbbed5b54
 
 PKG_MAINTAINER:=Ted Hess <thess@kitschensync.net>
-
 PKG_LICENSE:=GPL-2.0 LGPL-2.1
 PKG_LICENSE_FILES:=COPYING COPYING.libv4l
 
@@ -56,7 +52,7 @@ define Package/libv4l
   SECTION:=libs
   CATEGORY:=Libraries
   TITLE+= wrapper libraries
-  DEPENDS := +libpthread +librt $(ICONV_DEPENDS)
+  DEPENDS:= +libpthread +librt +libintl-full $(ICONV_DEPENDS)
 endef
 
 define Package/libv4l/description
@@ -68,7 +64,7 @@ define Package/v4l-utils
   SECTION:=utils
   CATEGORY:=Utilities
   TITLE+= utilities
-  DEPENDS := +libv4l $(CXX_DEPENDS) $(ICONV_DEPENDS)
+  DEPENDS:= +libintl-full +libv4l $(CXX_DEPENDS) $(ICONV_DEPENDS)
 endef
 
 define Package/v4l-utils/description
@@ -76,27 +72,28 @@ define Package/v4l-utils/description
   This package contains the video4linux utilities.
 endef
 
-TARGET_CFLAGS += $(FPIC)
-TARGET_LDFLAGS += -largp
+TARGET_CFLAGS += -flto
+TARGET_LDFLAGS += -largp -Wl,--gc-sections
 
 CONFIGURE_ARGS+= \
 	--disable-doxygen-doc \
 	--disable-libdvbv5 \
 	--disable-qv4l2 \
+	--disable-qvidcap \
 	--without-jpeg \
 
 define Build/InstallDev
 	$(INSTALL_DIR) $(1)/usr/include
 	$(CP) $(PKG_INSTALL_DIR)/usr/include/*.h $(1)/usr/include/
 	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libv4l{1,2,convert}.{a,so*} $(1)/usr/lib/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libv4l{1,2,convert,2rds}.{a,so*} $(1)/usr/lib/
 	$(INSTALL_DIR) $(1)/usr/lib/pkgconfig
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/libv4l{1,2,convert}.pc $(1)/usr/lib/pkgconfig/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/pkgconfig/libv4l{1,2,convert,2rds}.pc $(1)/usr/lib/pkgconfig/
 endef
 
 define Package/libv4l/install
 	$(INSTALL_DIR) $(1)/usr/lib
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libv4l{1,2,convert}.so.* $(1)/usr/lib/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libv4l{1,2,convert,2rds}.so.* $(1)/usr/lib/
 	$(INSTALL_DIR) $(1)/usr/lib/libv4l
 	$(CP) $(PKG_INSTALL_DIR)/usr/lib/libv4l/v4l{1compat,2convert}.so $(1)/usr/lib/libv4l/
 endef
@@ -106,10 +103,11 @@ define Package/v4l-utils/install
 	$(CP) $(PKG_INSTALL_DIR)/etc/rc_maps.cfg $(1)/etc/
 	$(CP) $(PKG_INSTALL_DIR)/etc/rc_keymaps $(1)/etc/
 	$(INSTALL_DIR) $(1)/usr/bin
-	$(CP) $(PKG_INSTALL_DIR)/usr/bin/{cx18,ivtv}-ctl $(1)/usr/bin/
+	$(CP) $(PKG_INSTALL_DIR)/usr/bin/{rds,media,cx18,ivtv}-ctl $(1)/usr/bin/
 	$(CP) $(PKG_INSTALL_DIR)/usr/bin/decode_tm6000 $(1)/usr/bin/
-	$(CP) $(PKG_INSTALL_DIR)/usr/bin/ir-keytable $(1)/usr/bin/
+	$(CP) $(PKG_INSTALL_DIR)/usr/bin/ir-{ctl,keytable} $(1)/usr/bin/
 	$(CP) $(PKG_INSTALL_DIR)/usr/bin/v4l2-{compliance,ctl,sysfs-path} $(1)/usr/bin/
+	$(CP) $(PKG_INSTALL_DIR)/usr/bin/cec-{compliance,ctl,follower} $(1)/usr/bin/
 endef
 
 $(eval $(call BuildPackage,libv4l))
diff --git a/libs/libv4l/patches/010-remove-libudev-check.patch b/libs/libv4l/patches/010-remove-libudev-check.patch
new file mode 100644
index 0000000..6a9784a
--- /dev/null
+++ b/libs/libv4l/patches/010-remove-libudev-check.patch
@@ -0,0 +1,22 @@
+--- a/configure.ac
++++ b/configure.ac
+@@ -283,16 +283,9 @@ else
+    AC_MSG_WARN(ALSA library not available)
+ fi
+ 
+-PKG_CHECK_MODULES(libudev, libudev, have_libudev=yes, have_libudev=no)
+-if test "x$have_libudev" = "xyes"; then
+-	AC_DEFINE([HAVE_LIBUDEV], [], [Use libudev])
+-	LIBUDEV_CFLAGS="$libudev_CFLAGS"
+-	LIBUDEV_LIBS="$libudev_LIBS"
+-	AC_SUBST(LIBUDEV_CFLAGS)
+-	AC_SUBST(LIBUDEV_LIBS)
+-else
+-   AC_MSG_WARN(udev library not available)
+-fi
++
++# Force building without udev
++have_libudev=no
+ 
+ AC_SUBST([JPEG_LIBS])
+ 
diff --git a/libs/libv4l/patches/020-add-missing-includes.patch b/libs/libv4l/patches/020-add-missing-includes.patch
index 34e0511..f1850c8 100644
--- a/libs/libv4l/patches/020-add-missing-includes.patch
+++ b/libs/libv4l/patches/020-add-missing-includes.patch
@@ -1,28 +1,64 @@
---- a/utils/rds-ctl/rds-ctl.cpp
-+++ b/utils/rds-ctl/rds-ctl.cpp
-@@ -29,6 +29,7 @@
- #include <inttypes.h>
- #include <getopt.h>
- #include <sys/types.h>
-+#include <ctype.h>
- #include <fcntl.h>
+--- a/utils/cec-ctl/cec-ctl.cpp
++++ b/utils/cec-ctl/cec-ctl.cpp
+@@ -18,6 +18,7 @@
  #include <errno.h>
  #include <sys/ioctl.h>
-@@ -36,6 +37,7 @@
- #include <dirent.h>
- #include <config.h>
- #include <signal.h>
-+#include <time.h>
+ #include <stdarg.h>
++#include <ctime>
+ #include <cerrno>
+ #include <string>
+ #include <vector>
+--- a/utils/cec-follower/cec-follower.h
++++ b/utils/cec-follower/cec-follower.h
+@@ -9,6 +9,7 @@
+ #define _CEC_FOLLOWER_H_
+ 
+ #include <stdarg.h>
++#include <ctime>
+ #include <cerrno>
+ #include <string>
+ #include <linux/cec-funcs.h>
+--- a/utils/common/media-info.cpp
++++ b/utils/common/media-info.cpp
+@@ -20,7 +20,7 @@
  
+ #include <linux/media.h>
+ 
+-#include <fstream>
++#include <iostream>
+ #include <media-info.h>
+ 
+ static std::string num2s(unsigned num, bool is_hex = true)
+--- a/utils/rds-ctl/rds-ctl.cpp
++++ b/utils/rds-ctl/rds-ctl.cpp
+@@ -27,6 +27,8 @@
  #include <linux/videodev2.h>
- #include <libv4l2.h>
---- a/utils/v4l2-ctl/v4l2-ctl-streaming.cpp
-+++ b/utils/v4l2-ctl/v4l2-ctl-streaming.cpp
-@@ -14,6 +14,7 @@
- #include <sys/mman.h>
- #include <dirent.h>
- #include <math.h>
-+#include <time.h>
+ #include <libv4l2rds.h>
+ 
++#include <cctype>
++#include <ctime>
+ #include <list>
+ #include <vector>
+ #include <map>
+--- a/utils/v4l2-compliance/media-info.cpp
++++ b/utils/v4l2-compliance/media-info.cpp
+@@ -20,7 +20,7 @@
+ 
+ #include <linux/media.h>
+ 
+-#include <fstream>
++#include <iostream>
+ #include <media-info.h>
+ 
+ static std::string num2s(unsigned num, bool is_hex = true)
+--- a/utils/v4l2-ctl/media-info.cpp
++++ b/utils/v4l2-ctl/media-info.cpp
+@@ -20,7 +20,7 @@
+ 
+ #include <linux/media.h>
  
- #include "v4l2-ctl.h"
+-#include <fstream>
++#include <iostream>
+ #include <media-info.h>
  
+ static std::string num2s(unsigned num, bool is_hex = true)
diff --git a/libs/libv4l/patches/030-dont-call-getsubopt.patch b/libs/libv4l/patches/030-dont-call-getsubopt.patch
deleted file mode 100644
index 5824c70..0000000
--- a/libs/libv4l/patches/030-dont-call-getsubopt.patch
+++ /dev/null
@@ -1,28 +0,0 @@
---- a/utils/v4l2-ctl/v4l2-ctl-common.cpp
-+++ b/utils/v4l2-ctl/v4l2-ctl-common.cpp
-@@ -671,15 +671,18 @@ static bool parse_subset(char *optarg)
- 
- static bool parse_next_subopt(char **subs, char **value)
- {
--	static char *const subopts[] = {
--	    NULL
--	};
--	int opt = getsubopt(subs, subopts, value);
-+	char *stmp = *subs;
-+	*value = NULL;
- 
--	if (opt < 0 || *value)
-+	if (*subs) {
-+		*subs = strchr(stmp, ',');
-+		if (*subs)
-+			*(*subs)++ = 0;
-+		else *subs = stmp + strlen(stmp);
-+
-+		*value = stmp;
- 		return false;
--	fprintf(stderr, "No value given to suboption <%s>\n",
--			subopts[opt]);
-+	}
- 	return true;
- }
- 
-- 
2.7.4

