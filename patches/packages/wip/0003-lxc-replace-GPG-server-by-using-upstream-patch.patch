From 122add33bcff9dfd82ef172bfc964bc22582e51d Mon Sep 17 00:00:00 2001
From: Josef Schlehofer <pepe.schlehofer@gmail.com>
Date: Sat, 10 Jul 2021 17:11:45 +0200
Subject: [PATCH] lxc: replace GPG server by using upstream patch

Reported and fixes issue described here:
https://forum.turris.cz/t/lxc-create-error-unable-to-fetch-gpg-key-from-keyserver/15636
---
 utils/lxc/Makefile                     |  2 +-
 utils/lxc/patches/035-GPG-change.patch | 47 ++++++++++++++++++++++++++
 2 files changed, 48 insertions(+), 1 deletion(-)
 create mode 100644 utils/lxc/patches/035-GPG-change.patch

diff --git a/utils/lxc/Makefile b/utils/lxc/Makefile
index 946476e..5c366b8 100644
--- a/utils/lxc/Makefile
+++ b/utils/lxc/Makefile
@@ -9,7 +9,7 @@ include $(TOPDIR)/rules.mk
 
 PKG_NAME:=lxc
 PKG_VERSION:=3.0.3
-PKG_RELEASE:=1
+PKG_RELEASE:=2
 
 PKG_LICENSE:=LGPL-2.1-or-later BSD-2-Clause GPL-2.0
 PKG_MAINTAINER:=Marko Ratkaj <marko.ratkaj@sartura.hr>
diff --git a/utils/lxc/patches/035-GPG-change.patch b/utils/lxc/patches/035-GPG-change.patch
new file mode 100644
index 0000000..70bbe6b
--- /dev/null
+++ b/utils/lxc/patches/035-GPG-change.patch
@@ -0,0 +1,47 @@
+From a08242fc033b39be7e782ad6455973ec07f62b61 Mon Sep 17 00:00:00 2001
+From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
+Date: Sun, 27 Jun 2021 23:42:52 -0400
+Subject: [PATCH] lxc-download: Switch GPG server
+MIME-Version: 1.0
+Content-Type: text/plain; charset=UTF-8
+Content-Transfer-Encoding: 8bit
+
+A few days ago, sks-keyservers.net pool announced that their service is
+deprecated and no longer maintained.
+
+References:
+Reddit.com [1]
+sks-keyservers.net [2] with invalid SSL certificate
+
+[1] https://www.reddit.com/r/crypto/comments/o7oh4w/skskeyserversnet_pool_dns_records_disabled/
+[2] https://sks-keyservers.net/
+
+Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
+(cherry picked from commit f2a5d95d00a55bed27ef9920d67617cc75fecad8)
+Signed-off-by: Josef Schlehofer <pepe.schlehofer@gmail.com>
+[added commit message]
+---
+ templates/lxc-download.in | 4 ++--
+ 1 file changed, 2 insertions(+), 2 deletions(-)
+
+diff --git a/templates/lxc-download.in b/templates/lxc-download.in
+index 51838e6..c59e84c 100644
+--- a/templates/lxc-download.in
++++ b/templates/lxc-download.in
+@@ -55,11 +55,11 @@ LXC_PATH=
+ LXC_ROOTFS=
+ 
+ if [ -z "${DOWNLOAD_KEYSERVER:-}" ]; then
+-  DOWNLOAD_KEYSERVER="hkp://pool.sks-keyservers.net"
++  DOWNLOAD_KEYSERVER="hkp://keyserver.ubuntu.com"
+ 
+   # Deal with GPG over http proxy
+   if [ -n "${http_proxy:-}" ]; then
+-    DOWNLOAD_KEYSERVER="hkp://p80.pool.sks-keyservers.net:80"
++    DOWNLOAD_KEYSERVER="hkp://keyserver.ubuntu.com:80"
+   fi
+ fi
+ 
+-- 
+2.30.2
+
-- 
2.30.2

