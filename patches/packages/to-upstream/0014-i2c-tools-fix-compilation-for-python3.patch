From c80955559d8512fd8a3df710b1a7625c7560972a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Karel=20Ko=C4=8D=C3=AD?= <cynerd@email.cz>
Date: Fri, 15 Feb 2019 14:50:17 +0100
Subject: [PATCH] i2c-tools: rework package to use variants

---
 utils/i2c-tools/Makefile | 61 ++++++++++++++++++----------------------
 1 file changed, 27 insertions(+), 34 deletions(-)

diff --git a/utils/i2c-tools/Makefile b/utils/i2c-tools/Makefile
index 88dd6b3f6..9733a7e6c 100644
--- a/utils/i2c-tools/Makefile
+++ b/utils/i2c-tools/Makefile
@@ -13,21 +13,21 @@ PKG_RELEASE:=1
 
 PKG_SOURCE_URL:=http://dl.lm-sensors.org/i2c-tools/releases/ \
                 http://fossies.org/linux/misc/
-
 PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.bz2
 PKG_HASH:=db5e69f2e2a6e3aa2ecdfe6a5f490b149c504468770f58921c8c5b8a7860a441
 
-PKG_BUILD_PARALLEL:=1
-PKG_BUILD_DEPENDS:=PACKAGE_python-smbus:python
-
 PKG_MAINTAINER:=Daniel Golle <daniel@makrotopia.org>
 PKG_LICENSE:=GPLv2
 PKG_LICENSE_FILES:=COPYING
 
+PKG_BUILD_DIR:=$(BUILD_DIR)/$(BUILD_VARIANT)-i2c-tools-$(PKG_VERSION)
+
 include $(INCLUDE_DIR)/package.mk
 include ../../lang/python/python-package.mk
 include ../../lang/python/python3-package.mk
 
+PKG_UNPACK:=$(HOST_TAR) -C $(PKG_BUILD_DIR) --strip-components=1 -xjf $(DL_DIR)/$(PKG_SOURCE)
+
 define Package/i2c/Default
   URL:=http://lm-sensors.org/wiki/I2CTools
   TITLE:=I2C
@@ -38,6 +38,7 @@ define Package/i2c-tools
   SECTION:=utils
   CATEGORY:=Utilities
   TITLE+=tools for Linux
+  VARIANT:=bin
 endef
 
 define Package/python-smbus
@@ -47,6 +48,7 @@ define Package/python-smbus
   CATEGORY:=Languages
   TITLE:=Python bindings for the SMBUS
   DEPENDS:=+python-light
+  VARIANT:=python
 endef
 
 define Package/python3-smbus
@@ -56,6 +58,7 @@ define Package/python3-smbus
   CATEGORY:=Languages
   TITLE:=Python bindings for the SMBUS
   DEPENDS:=+python3-light
+  VARIANT:=python3
 endef
 
 define Package/i2c-tools/description
@@ -68,29 +71,12 @@ define Package/python-smbus/description
 endef
 
 define Package/python3-smbus/description
- This package contain the python bindings for Linux SMBus access through i2c-dev.
+ This package contain the Python3 bindings for Linux SMBus access through i2c-dev.
 endef
 
 TARGET_CPPFLAGS += -I$(PKG_BUILD_DIR)/include
 
-ifdef CONFIG_PACKAGE_python-smbus
-  define Build/Compile/python-smbus
-	$(if $(Build/Compile/PyMod),,@echo Python packaging code not found.; false)
-	$(call Build/Compile/PyMod,./py-smbus/, \
-		install --prefix="$(PKG_INSTALL_DIR)/usr", \
-	)
-  endef
-endif
-
-ifdef CONFIG_PACKAGE_python3-smbus
-  define Build/Compile/python3-smbus
-	$(if $(Build/Compile/Py3Mod),,@echo Python3 packaging code not found.; false)
-	$(call Build/Compile/Py3Mod,./py-smbus/, \
-		install --prefix="$(PKG_INSTALL_DIR)/usr", \
-	)
-  endef
-endif
-
+ifeq ($(BUILD_VARIANT),bin)
 define Build/Compile
 	$(MAKE) -C $(PKG_BUILD_DIR) \
 		LINUX="$(LINUX_DIR)" \
@@ -98,9 +84,24 @@ define Build/Compile
 		STAGING_DIR="$(STAGING_DIR)" \
 		LDFLAGS="$(TARGET_LDFLAGS)" \
 		CFLAGS="$(TARGET_CFLAGS)"
-	$(Build/Compile/python-smbus)
-	$(Build/Compile/python3-smbus)
 endef
+endif
+
+define PyBuild/Compile
+	$(call Build/Compile/PyMod,./py-smbus/, \
+		install --prefix="/usr" --root="$(PKG_INSTALL_DIR)" \
+		$(PYTHON_PKG_SETUP_ARGS), \
+		$(PYTHON_PKG_SETUP_VARS) \
+	)
+endif
+
+define Py3Build/Compile
+	$(call Build/Compile/Py3Mod,./py-smbus/, \
+		install --prefix="/usr" --root="$(PKG_INSTALL_DIR)" \
+		$(PYTHON3_PKG_SETUP_ARGS), \
+		$(PYTHON3_PKG_SETUP_VARS) \
+	)
+endif
 
 define Package/i2c-tools/install
 	$(INSTALL_DIR) $(1)/usr/sbin
@@ -110,16 +111,8 @@ define Package/i2c-tools/install
 	$(INSTALL_BIN) $(PKG_BUILD_DIR)/tools/i2cget $(1)/usr/sbin/
 endef
 
-define PyPackage/python-smbus/filespec
-+|$(PYTHON_PKG_DIR)
-endef
-
-define PyPackage/python3-smbus/filespec
-+|$(PYTHON3_PKG_DIR)
-endef
-
 $(eval $(call BuildPackage,i2c-tools))
 $(eval $(call PyPackage,python-smbus))
 $(eval $(call BuildPackage,python-smbus))
-$(eval $(call PyPackage,python3-smbus))
+$(eval $(call Py3Package,python3-smbus))
 $(eval $(call BuildPackage,python3-smbus))
-- 
2.20.1

