From 53c80906f35a6671220277fe4e7d407ed8bf7703 Mon Sep 17 00:00:00 2001
From: Michal Hrusecky <michal.hrusecky@nic.cz>
Date: Thu, 2 Aug 2018 14:39:39 +0200
Subject: [PATCH] luajit: Try to build something on 64bits

---
 lang/luajit/Makefile                  |  8 ++++----
 lang/luajit/patches/64bit-build.patch | 27 +++++++++++++++++++++++++++
 2 files changed, 31 insertions(+), 4 deletions(-)
 create mode 100644 lang/luajit/patches/64bit-build.patch

diff --git a/lang/luajit/Makefile b/lang/luajit/Makefile
index e1f2a74..33a82cd 100644
--- a/lang/luajit/Makefile
+++ b/lang/luajit/Makefile
@@ -32,7 +32,7 @@ define Package/luajit/description
 endef
 
 ifeq ($(HOST_ARCH),x86_64)
-  ifeq ($(CONFIG_x86_64),)
+  ifeq ($(CONFIG_ARCH_64BIT),)
     HOST_BITS := -m32
   endif
 endif
@@ -69,9 +69,9 @@ endef
 
 define Package/luajit/install
 	$(INSTALL_DIR) $(1)/usr/lib/
-	$(CP) $(PKG_INSTALL_DIR)/usr/lib/*.so $(1)/usr/lib/
+	$(CP) $(PKG_INSTALL_DIR)/usr/lib/*.so* $(1)/usr/lib/
 	$(INSTALL_DIR) $(1)/usr/bin
-	$(CP) $(PKG_INSTALL_DIR)/usr/bin/luajit-2.1.0-beta2 $(1)/usr/bin/$(PKG_NAME)
+	$(CP) $(PKG_INSTALL_DIR)/usr/bin/luajit* $(1)/usr/bin/$(PKG_NAME)
 endef
 
 define Host/Compile
@@ -85,7 +85,7 @@ define Host/Install
 	$(MAKE) $(HOST_JOBS) -C $(HOST_BUILD_DIR) \
 		DPREFIX=$(STAGING_DIR_HOSTPKG) \
 		install
-	$(CP) $(STAGING_DIR_HOSTPKG)/bin/luajit-2.1.0-beta2 $(STAGING_DIR_HOSTPKG)/bin/$(PKG_NAME)
+	$(CP) $(STAGING_DIR_HOSTPKG)/bin/luajit* $(STAGING_DIR_HOSTPKG)/bin/$(PKG_NAME)
 endef
 
 $(eval $(call HostBuild,luajit))
diff --git a/lang/luajit/patches/64bit-build.patch b/lang/luajit/patches/64bit-build.patch
new file mode 100644
index 000000000..908b8f1ec
--- /dev/null
+++ b/lang/luajit/patches/64bit-build.patch
@@ -0,0 +1,27 @@
+Index: luajit-2017-01-17-71ff7ef/src/lj_obj.h
+===================================================================
+--- luajit-2017-01-17-71ff7ef.orig/src/lj_obj.h
++++ luajit-2017-01-17-71ff7ef/src/lj_obj.h
+@@ -16,10 +16,11 @@
+ /* -- Memory references (32 bit address space) ---------------------------- */
+ 
+ /* Memory and GC object sizes. */
+-typedef uint32_t MSize;
+ #if LJ_GC64
+ typedef uint64_t GCSize;
++typedef uint64_t MSize;
+ #else
++typedef uint32_t MSize;
+ typedef uint32_t GCSize;
+ #endif
+ 
+@@ -358,9 +359,6 @@ typedef struct GCproto {
+   uint8_t numparams;	/* Number of parameters. */
+   uint8_t framesize;	/* Fixed frame size. */
+   MSize sizebc;		/* Number of bytecode instructions. */
+-#if LJ_GC64
+-  uint32_t unused_gc64;
+-#endif
+   GCRef gclist;
+   MRef k;		/* Split constant array (points to the middle). */
+   MRef uv;		/* Upvalue list. local slot|0x8000 or parent uv idx. */
-- 
2.19.2

