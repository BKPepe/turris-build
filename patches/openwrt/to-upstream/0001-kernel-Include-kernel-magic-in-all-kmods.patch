From bbab5a593a3141bcc0c584b3f295aa1b95cfecce Mon Sep 17 00:00:00 2001
From: Michal Hrusecky <Michal@Hrusecky.net>
Date: Mon, 19 Feb 2018 22:02:58 +0100
Subject: [PATCH] kernel: Include kernel magic in all kmods

Kernel modules can greatly depend on configuration of the kernel and might not
work with different kernel, so always put kernel magic as part of the package
version.

Also install modules into directories versioned by the kernel magic.

Signed-off-by: Michal Hrusecky <Michal@Hrusecky.net>
---
 include/kernel.mk | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/include/kernel.mk b/include/kernel.mk
index 77c5ecf..814e4e0 100644
--- a/include/kernel.mk
+++ b/include/kernel.mk
@@ -67,7 +67,7 @@ else
       LINUX_UNAME_VERSION:=$(strip $(shell cat $(LINUX_DIR)/include/config/kernel.release 2>/dev/null))
   endif
 
-  MODULES_SUBDIR:=lib/modules/$(LINUX_UNAME_VERSION)
+  MODULES_SUBDIR:=lib/modules/$(LINUX_UNAME_VERSION)-$(LINUX_VERMAGIC)
   TARGET_MODULES_DIR:=$(LINUX_TARGET_DIR)/$(MODULES_SUBDIR)
 
   ifneq ($(TARGET_BUILD),1)
@@ -196,7 +196,7 @@ define KernelPackage
     CATEGORY:=Kernel modules
     DESCRIPTION:=$(DESCRIPTION)
     EXTRA_DEPENDS:=kernel (=$(LINUX_VERSION)-$(LINUX_RELEASE)-$(LINUX_VERMAGIC))
-    VERSION:=$(LINUX_VERSION)$(if $(PKG_VERSION),+$(PKG_VERSION))-$(if $(PKG_RELEASE),$(PKG_RELEASE),$(LINUX_RELEASE))
+    VERSION:=$(LINUX_VERSION)$(if $(PKG_VERSION),+$(PKG_VERSION))-$(if $(PKG_RELEASE),$(PKG_RELEASE),$(LINUX_RELEASE))-$(LINUX_VERMAGIC)
     PKGFLAGS:=$(PKGFLAGS)
     $(call KernelPackage/$(1))
     $(call KernelPackage/$(1)/$(BOARD))
-- 
2.19.1

