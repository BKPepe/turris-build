From 841ee10970e1951bb3af23c149edd18cfe0e77c4 Mon Sep 17 00:00:00 2001
From: Michal Hrusecky <Michal@Hrusecky.net>
Date: Thu, 22 Feb 2018 14:46:46 +0100
Subject: [PATCH] busybox: Provide static busybox build

Can be handy, but currently it is quite hacky.

Signed-off-by: Michal Hrusecky <Michal@Hrusecky.net>
---
 package/utils/busybox/Makefile | 34 ++++++++++++++++++++++++++++++++++
 1 file changed, 34 insertions(+)

diff --git a/package/utils/busybox/Makefile b/package/utils/busybox/Makefile
index 315dd42..1965658 100644
--- a/package/utils/busybox/Makefile
+++ b/package/utils/busybox/Makefile
@@ -66,6 +66,20 @@ define Package/busybox/description
  It slices, it dices, it makes Julian Fries.
 endef
 
+define Package/busybox-static
+  SECTION:=base
+  CATEGORY:=Base system
+  MAINTAINER:=Felix Fietkau <nbd@openwrt.org>
+  TITLE:=Core utilities for embedded Linux
+  URL:=http://busybox.net/
+endef
+
+define Package/busybox-static/description
+ The Swiss Army Knife of embedded Linux.
+ It slices, it dices, it makes Julian Fries.
+ Static minimal build meant to be used for recovery.
+endef
+
 define Package/busybox/config
 	source "$(SOURCE)/Config.in"
 endef
@@ -101,11 +115,20 @@ ifneq ($(findstring c,$(OPENWRT_VERBOSE)),)
 endif
 
 define Build/Configure
+	cp ./files/busybox-static.config $(PKG_BUILD_DIR)/.config
+	echo 'CONFIG_STATIC=y' >> $(PKG_BUILD_DIR)/.config
+	yes 'n' | $(MAKE) -C $(PKG_BUILD_DIR) $(MAKE_FLAGS) oldconfig
+	mv $(PKG_BUILD_DIR)/.config $(PKG_BUILD_DIR)/.config-static
 	grep 'CONFIG_BUSYBOX_$(BUSYBOX_SYM)' $(TOPDIR)/.config | sed -e "s,\\(# \)\\?CONFIG_BUSYBOX_$(BUSYBOX_SYM)_\\(.*\\),\\1CONFIG_\\2,g" > $(PKG_BUILD_DIR)/.config
 	yes 'n' | $(MAKE) -C $(PKG_BUILD_DIR) $(MAKE_FLAGS) oldconfig
+	mv $(PKG_BUILD_DIR)/.config $(PKG_BUILD_DIR)/.config-regular
 endef
 
 define Build/Compile
+	cp $(PKG_BUILD_DIR)/.config-static $(PKG_BUILD_DIR)/.config
+	$(call Build/Compile/Default)
+	cp $(PKG_BUILD_DIR)/busybox $(PKG_BUILD_DIR)/busybox-static
+	cp $(PKG_BUILD_DIR)/.config-regular $(PKG_BUILD_DIR)/.config
 	$(call Build/Compile/Default, \
 		CONFIG_PREFIX="$(PKG_INSTALL_DIR)" \
 		all install \
@@ -125,4 +148,15 @@ endif
 	-rm -rf $(1)/lib64
 endef
 
+define Build/InstallDev
+	$(INSTALL_DIR) $(1)/bin
+	$(CP) $(PKG_BUILD_DIR)/busybox-static $(1)/bin
+endef
+
+define Package/busybox-static/install
+	$(INSTALL_DIR) $(1)/bin
+	$(CP) $(PKG_BUILD_DIR)/busybox-static $(1)/bin
+endef
+
 $(eval $(call BuildPackage,busybox))
+$(eval $(call BuildPackage,busybox-static))
-- 
2.18.0

