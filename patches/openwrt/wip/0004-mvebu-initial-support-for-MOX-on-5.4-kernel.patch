From 739123196cc4bdb6eb1005d561cdf5987cc6d4f7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Beh=C3=BAn?= <marek.behun@nic.cz>
Date: Thu, 30 Apr 2020 00:18:17 +0200
Subject: [PATCH] mvebu: initial support for MOX on 5.4 kernel

---
 package/boot/uboot-tools/files/mvebu          |   3 +
 .../base-files/etc/board.d/02_network         |  12 ++
 target/linux/mvebu/cortexa53/config-5.15       |  13 ++
 target/linux/mvebu/image/cortexa53.mk         |  12 ++
 ...is-mox-rwtm-support-ECDSA-signatures.patch | 158 ++++++++++++++++++
 ...Zero-max-link-speed-value-is-invalid.patch |  32 ++++
 ...x-implement-phylink-AN-restart-on-Se.patch | 137 +++++++++++++++
 7 files changed, 367 insertions(+)

diff --git a/package/boot/uboot-tools/files/mvebu b/package/boot/uboot-tools/files/mvebu
index 92b144330f..c298dfc63a 100644
--- a/package/boot/uboot-tools/files/mvebu
+++ b/package/boot/uboot-tools/files/mvebu
@@ -24,6 +24,9 @@ cznic,turris-omnia)
 		ubootenv_add_uci_config "/dev/mtd0" "0xf0000" "0x10000" "0x10000"
 	fi
 	;;
+cznic,turris-mox)
+	ubootenv_add_uci_config "/dev/mtd2" "0x0" "0x00010000"
+	;;
 glinet,gl-mv1000)
 	ubootenv_add_uci_config "/dev/mtd1" "0x0" "0x8000" "0x8000" "1"
 	;;
diff --git a/target/linux/mvebu/cortexa53/base-files/etc/board.d/02_network b/target/linux/mvebu/cortexa53/base-files/etc/board.d/02_network
index c945251e4e..ad76a31ba9 100755
--- a/target/linux/mvebu/cortexa53/base-files/etc/board.d/02_network
+++ b/target/linux/mvebu/cortexa53/base-files/etc/board.d/02_network
@@ -11,6 +11,18 @@ board_config_update
 board=$(board_name)
 
 case "$board" in
+cznic,turris-mox)
+	mox_lan_interfaces=""
+	for net in /sys/class/net/lan*; do
+		[ -e "$net" ] || continue
+		append mox_lan_interfaces "${net##*/}"
+	done
+	if [ -z "$mox_lan_interfaces" ]; then
+		ucidef_set_interface_lan "eth0"
+	else
+		ucidef_set_interfaces_lan_wan "$mox_lan_interfaces" "eth0"
+	fi
+	;;
 glinet,gl-mv1000|\
 globalscale,espressobin|\
 globalscale,espressobin-emmc|\
diff --git a/target/linux/mvebu/cortexa53/config-5.15 b/target/linux/mvebu/cortexa53/config-5.15
index 8024af6f74..58d088182d 100644
--- a/target/linux/mvebu/cortexa53/config-5.15
+++ b/target/linux/mvebu/cortexa53/config-5.15
@@ -23,6 +23,8 @@ CONFIG_ARM64_SVE=y
 CONFIG_ARM64_TAGGED_ADDR_ABI=y
 CONFIG_ARM64_VA_BITS=39
 CONFIG_ARM64_VA_BITS_39=y
+CONFIG_ARMADA_37XX_RWTM_MBOX=y
+CONFIG_ARMADA_37XX_WATCHDOG=y
 CONFIG_ARM_AMBA=y
 CONFIG_ARM_ARCH_TIMER=y
 CONFIG_ARM_ARCH_TIMER_EVTSTREAM=y
@@ -68,7 +70,12 @@ CONFIG_GENERIC_IRQ_EFFECTIVE_AFF_MASK=y
 CONFIG_GENERIC_MSI_IRQ=y
 CONFIG_GENERIC_MSI_IRQ_DOMAIN=y
 CONFIG_GENERIC_TIME_VSYSCALL=y
+CONFIG_GPIO_MOXTET=y
+CONFIG_I2C_PXA=y
+# CONFIG_I2C_PXA_SLAVE is not set
 CONFIG_ILLEGAL_POINTER_VALUE=0xdead000000000000
+CONFIG_MAILBOX=y
+# CONFIG_MAILBOX_TEST is not set
 CONFIG_IRQ_DOMAIN_HIERARCHY=y
 CONFIG_LIBCRC32C=y
 CONFIG_LOCK_SPIN_ON_OWNER=y
@@ -120,3 +127,9 @@ CONFIG_ZLIB_INFLATE=y
 CONFIG_ZONE_DMA32=y
 CONFIG_ZSTD_COMPRESS=y
 CONFIG_ZSTD_DECOMPRESS=y
+CONFIG_MOXTET=y
+CONFIG_MTD_M25P80=y
+CONFIG_MTD_SPI_NOR=y
+CONFIG_MTD_SPI_NOR_USE_4K_SECTORS=y
+CONFIG_RTC_DRV_DS1307=y
+CONFIG_TURRIS_MOX_RWTM=y
diff --git a/target/linux/mvebu/image/cortexa53.mk b/target/linux/mvebu/image/cortexa53.mk
index 6a3a568655..ab694ab4fb 100644
--- a/target/linux/mvebu/image/cortexa53.mk
+++ b/target/linux/mvebu/image/cortexa53.mk
@@ -1,3 +1,15 @@
+define Device/cznic-mox
+  KERNEL_NAME := Image dtbs
+  KERNEL := kernel-bin
+  DEVICE_VENDOR := CZ.NIC
+  DEVICE_MODEL := Turris MOX
+  DEVICE_DTS := armada-3720-turris-mox
+  DEVICE_PACKAGES := kmod-usb2 kmod-gpio-button-hotplug
+  DEVICE_DTS_DIR := $(DTS_DIR)/marvell
+  SUPPORTED_DEVICES := cznic,mox
+endef
+TARGET_DEVICES += cznic-mox
+
 define Device/glinet_gl-mv1000
   $(call Device/Default-arm64)
   DEVICE_VENDOR := GL.iNet
-- 
2.34.1

