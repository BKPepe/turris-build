From e74fa05ec7dcef0e44f9eaccd83cadbd9612e142 Mon Sep 17 00:00:00 2001
From: Josef Schlehofer <pepe.schlehofer@gmail.com>
Date: Tue, 23 Nov 2021 18:27:24 +0100
Subject: [PATCH 2/3] Revert "turris-webapps-netdata: protect with turris-auth
 login gateway"

This reverts commit d490c71c5cd963333ef2f432587048d152db2d8c.
---
 web/turris-webapps/turris-webapps-netdata/Makefile     |  9 ++++-----
 .../turris-webapps-netdata/files/netdata.lighttpd      | 10 ++++++++--
 2 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/web/turris-webapps/turris-webapps-netdata/Makefile b/web/turris-webapps/turris-webapps-netdata/Makefile
index cfaa682c5..c1140722f 100644
--- a/web/turris-webapps/turris-webapps-netdata/Makefile
+++ b/web/turris-webapps/turris-webapps-netdata/Makefile
@@ -9,7 +9,7 @@ include $(TOPDIR)/rules.mk
 
 PKG_NAME:=turris-webapps-netdata
 PKG_VERSION:=1.1
-PKG_RELEASE:=4
+PKG_RELEASE:=3
 
 PKG_MAINTAINER:=CZ.NIC <packaging@turris.cz>
 PKG_LICENSE:=GPL-3.0-or-later
@@ -23,9 +23,7 @@ define Package/turris-webapps-netdata
   TITLE:=Netdata integration
   DEPENDS:=+netdata \
     +turris-webapps \
-    +turris-auth \
-    +lighttpd-mod-proxy \
-    +lighttpd-mod-setenv
+    +lighttpd-mod-authn_pam +lighttpd-mod-proxy
   URL:=https://gitlab.nic.cz/turris/webapps
 endef
 
@@ -34,7 +32,8 @@ define Package/turris-webapps-netdata/description
   See https://www.netdata.cloud/
 endef
 
-Build/Compile:=:
+define Build/Compile
+endef
 
 define Package/turris-webapps-netdata/install
 	$(INSTALL_DIR) $(1)/etc/lighttpd/conf.d
diff --git a/web/turris-webapps/turris-webapps-netdata/files/netdata.lighttpd b/web/turris-webapps/turris-webapps-netdata/files/netdata.lighttpd
index 7aa5c7231..8eff2eeb0 100644
--- a/web/turris-webapps/turris-webapps-netdata/files/netdata.lighttpd
+++ b/web/turris-webapps/turris-webapps-netdata/files/netdata.lighttpd
@@ -1,12 +1,18 @@
 $HTTP["url"] =~ "^/netdata/" {
-  fastcgi.server = ( "/" => ( turris_auth_scriptname => turris_auth ))
+  auth.backend = "pam" 
+  auth.require = ( "" =>
+                   (
+                     "method"    => "basic",
+                     "realm"     => "Netdata",
+                     "require"   => "valid-user" 
+                   )
+                 )
   proxy.header = (
     "map-host-request" => ( "-" => "127.0.0.1" ),
     "map-urlpath" => ( "/netdata" => "", "/netdata/" => "/" ),
     "https-remap" => "enable"
   )
   proxy.server = ( "" => ( ( "host" => "127.0.0.1", "port" => "19999") ) )
-  setenv.add-response-header = ("Cache-Control" => "must-revalidate, proxy-revalidate, max-age=0")
 }
 
 $HTTP["url"] =~ "^/netdata$" {
-- 
2.30.2

