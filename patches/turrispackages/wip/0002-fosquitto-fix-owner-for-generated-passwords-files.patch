From a6a6e13a764d0b857b2ad8016f74b1f9076ad5b0 Mon Sep 17 00:00:00 2001
From: Jan Pavlinec <jan.pavlinec@nic.cz>
Date: Wed, 21 Apr 2021 13:51:36 +0200
Subject: [PATCH] fosquitto: fix owner for generated passwords files

---
 web/foris-controller/fosquitto/Makefile             |  2 +-
 web/foris-controller/fosquitto/files/fosquitto.init | 13 +++++++++++++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/web/foris-controller/fosquitto/Makefile b/web/foris-controller/fosquitto/Makefile
index 7195a912c..7cefd8b02 100644
--- a/web/foris-controller/fosquitto/Makefile
+++ b/web/foris-controller/fosquitto/Makefile
@@ -9,7 +9,7 @@ include $(TOPDIR)/rules.mk
 
 PKG_NAME:=fosquitto
 PKG_VERSION:=21
-PKG_RELEASE:=1
+PKG_RELEASE:=2
 
 PKG_MAINTAINER:=CZ.NIC <packaging@turris.cz>
 
diff --git a/web/foris-controller/fosquitto/files/fosquitto.init b/web/foris-controller/fosquitto/files/fosquitto.init
index ffaf800cf..402d9b6d5 100644
--- a/web/foris-controller/fosquitto/files/fosquitto.init
+++ b/web/foris-controller/fosquitto/files/fosquitto.init
@@ -19,6 +19,8 @@ generate_password() {
 	echo "local:${new_password}" > "${PLAIN_PASSWORD}"
 	cp "${PLAIN_PASSWORD}" "${HASHED_PASSWORD}"
 	mosquitto_passwd -U "${HASHED_PASSWORD}"
+	chown mosquitto "${HASHED_PASSWORDS}"
+	chown mosquitto "${PLAIN_PASSWORDS}"
 	umask ${stored_umask}
 
 	# Sync these files just to make sure that content is written to disk.
@@ -120,6 +122,16 @@ check_credentials_files() {
 	[ -e "$PLAIN_PASSWORD" -a -e "$HASHED_PASSWORD" ]
 }
 
+check_credentials_files_owner() {
+	local hash_owner="$(stat -c '%U' $HASHED_PASSWORD)"
+	local plain_owner="$(stat -c '%U' $PLAIN_PASSWORD)"
+
+	if [ "$hash_owner" != "mosquitto" -o "$plain_owner" != "mosquitto" ]; then
+		chown mosquitto "${HASHED_PASSWORD}"
+		chown mosquitto "${PLAIN_PASSWORD}"
+	fi
+}
+
 start_service() {
 	mkdir -p "/var/etc"
 	generate_config
@@ -128,6 +140,7 @@ start_service() {
 		generate_password
 	fi
 	try_chown_dirs
+	check_credentials_files_owner
 
 	procd_open_instance
 	procd_set_param command mosquitto
-- 
2.25.1

