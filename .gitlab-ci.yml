image: registry.labs.nic.cz/turris/turris-build

stages:
  - build
  - verify

Applying patches for Omnia:
  stage: build
  script:
    - './compile_pkgs prepare -t omnia'

Applying patches for Turris MOX:
  stage: build
  script:
    - './compile_pkgs prepare -t mox'

Medkit for Turris Omnia:
  stage: build
  script:
    - './generate_medkits.sh -t omnia'
    - 'find omnia-medkit.tar.gz* && echo "Omnia medkit was found!"'

Generate pkglists:
  stage: build
  script:
    - './generate_lists --debug'
  artifacts:
      name: "Generated package lists"
      paths:
          - generated_lists/*

Check for generated pkglists:
  stage: verify
  needs: ["Generate pkglists"]
  script:
    - find generated_lists -type f -name '*.lua' -printf '-- %P --\n' -exec luac5.1 -p '{}' \;
